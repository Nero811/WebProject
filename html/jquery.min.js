// 商品查詢功能
let products = [];

// 商品查詢功能頁籤
$("#nav-productsSelect").click(() => {
  console.log("click!!");
  // 隱藏創建商品功能container
  $("div.createProduct").css("display", "none");
  // 隱藏修改商品功能container
  $("div.updateProduct").css("display", "none");
  // 顯示商品查詢功能container
  $("div.productsSelect").css("display", "");
});

$("#searhProducts").click(() => {
  //   let tbody = document.getElementById("tbody");
  //   // 重置列表
  //   tbody.innerHTML = "";
  let pageLink = document.getElementsByClassName("page-link");
  console.log(Number(pageLink[1].innerHTML));
  // 重置分頁數
  for (let i = 2; i < pageLink.length - 1; i++) {
    console.log("777");
    pageLink[i].remove();
  }
  let URL = "http://localhost:8080/products";
  let search = document.getElementById("search");
  let productCategory = document.getElementById("productCategory-select");
  let orderBy = document.getElementById("orderBy-select");
  let sort = document.getElementById("sort-select");
  let limit = document.getElementById("limit");

  // 商品關鍵字
  if (search.value != "") {
    if (URL != "http://localhost:8080/products") {
      // 表示不是第一個被選擇的表單
      URL += "&search=" + search.value;
    } else {
      URL += "?search=" + search.value;
    }
  }
  // 商品總類select
  if (productCategory.value != "") {
    if (URL != "http://localhost:8080/products") {
      // 表示不是第一個被選擇的表單
      URL += "&category=" + productCategory.value;
    } else {
      URL += "?category=" + productCategory.value;
    }
  }
  // orderby方式
  if (orderBy.value != "") {
    if (URL != "http://localhost:8080/products") {
      // 表示不是第一個被選擇的表單
      URL += "&order=" + orderBy.value;
    } else {
      URL += "?order=" + orderBy.value;
    }
  }
  // sort方式
  if (sort.value != "") {
    if (URL != "http://localhost:8080/products") {
      // 表示不是第一個被選擇的表單
      URL += "&sort=" + sort.value;
    } else {
      URL += "?sort=" + sort.value;
    }
  }
  // 顯示幾筆(limit)
  if (limit.value != "") {
    if (URL != "http://localhost:8080/products") {
      // 表示不是第一個被選擇的表單
      URL += "&limit=" + limit.value;
    } else {
      URL += "?limit=" + limit.value;
    }
  }
  console.log(URL);
  ajaxCreateTable(URL);
  //   $.ajax({
  //     url: URL,
  //   })
  //     .done((data) => {
  //       products = data.result;
  //       console.log(products);
  //       console.log(products.length);
  //       for (let i = 0; i < products.length; i++) {
  //         // let tbody = document.getElementById("tbody");
  //         let newTr = document.createElement("tr");
  //         // 商品ID
  //         let newTd_productId = document.createElement("td");
  //         newTd_productId.innerHTML = products[i].productId;
  //         // 商品名稱
  //         let newTd_productName = document.createElement("td");
  //         // newTd_productName.innerHTML = products[i].productName;
  //         // 商品類別
  //         let newTd_category = document.createElement("td");
  //         newTd_category.innerHTML = products[i].category;
  //         // 商品售價
  //         let newTd_price = document.createElement("td");
  //         newTd_price.innerHTML = products[i].price;
  //         // 商品庫存
  //         let newTd_stock = document.createElement("td");
  //         newTd_stock.innerHTML = products[i].stock;
  //         // 商品介紹
  //         let newTd_description = document.createElement("td");
  //         if (products[i].description == null) {
  //           // 若介紹為空
  //           newTd_description.innerHTML = "無。";
  //         } else {
  //           newTd_description.innerHTML = products[i].description;
  //         }
  //         // 創建日期
  //         let newTd_createdDate = document.createElement("td");
  //         newTd_createdDate.innerHTML = products[i].createdDate;
  //         // 圖片連結
  //         let newAnchor = document.createElement("a");
  //         newAnchor.href = products[i].imageUrl;
  //         newAnchor.innerHTML = products[i].productName;
  //         newAnchor.target = "_blank";
  //         newTd_productName.appendChild(newAnchor);
  //         newTr.appendChild(newTd_productId);
  //         newTr.appendChild(newTd_productName);
  //         newTr.appendChild(newTd_category);
  //         newTr.appendChild(newTd_price);
  //         newTr.appendChild(newTd_stock);
  //         newTr.appendChild(newTd_description);
  //         newTr.appendChild(newTd_createdDate);
  //         tbody.appendChild(newTr);
  //       }
  //       // 計算分頁
  //       countPages(limit, products);
  //       //   if (limit.value == "") {
  //       //     limit.value = 5; // 沒有輸入值default = 5
  //       //   }
  //       //   let NumberOfPages = Math.floor(products.length / limit.value);
  //       //   let pagination = document.getElementsByClassName("pagination");
  //       //   let pageItem = document.getElementsByClassName("page-item");
  //       //   pageItem[2].remove(); // 先將next remove，最後計算完再加回去
  //       //   let pageLink = document.getElementsByClassName("page-link");
  //       //   console.log(Number(pageLink[1].innerHTML));
  //       //   for (let i = 0; i < NumberOfPages; i++) {
  //       //     let newPage = document.createElement("li");
  //       //     let newA = document.createElement("a");
  //       //     newPage.classList.add("page-item");
  //       //     newA.classList.add("page-link");
  //       //     newA.innerHTML = Number(pageLink[i + 1].innerHTML) + 1;
  //       //     newPage.appendChild(newA);
  //       //     pagination[0].append(newPage);
  //       //   }
  //       //   // 加回next
  //       //   let newPage = document.createElement("li");
  //       //   let newA = document.createElement("a");
  //       //   newPage.classList.add("page-item");
  //       //   newA.classList.add("page-link");
  //       //   newA.innerHTML = "Next";
  //       //   newPage.appendChild(newA);
  //       //   pagination[0].append(newPage);
  // $("a.page-link").click(() => {
  //   console.log("click page button !!");
  //   URL += "&offset=" + limit.value;
  //   console.log(URL);
  // });
  //     })
  //     .fail((errorThrown) => {
  //       console.log(errorThrown);
  //     });
});

// 商品查詢，創建列表
function ajaxCreateTable(URL) {
  $.ajax({
    url: URL,
  })
    .done((data) => {
      let tbody = document.getElementById("tbody");
      // 重置列表
      tbody.innerHTML = "";
      products = data.result;
      console.log(products);
      console.log(products.length);
      for (let i = 0; i < products.length; i++) {
        // let tbody = document.getElementById("tbody");
        let newTr = document.createElement("tr");
        // 商品ID
        let newTd_productId = document.createElement("td");
        newTd_productId.innerHTML = products[i].productId;
        // 商品名稱
        let newTd_productName = document.createElement("td");
        // newTd_productName.innerHTML = products[i].productName;
        // 商品類別
        let newTd_category = document.createElement("td");
        newTd_category.innerHTML = products[i].category;
        // 商品售價
        let newTd_price = document.createElement("td");
        newTd_price.innerHTML = products[i].price;
        // 商品庫存
        let newTd_stock = document.createElement("td");
        newTd_stock.innerHTML = products[i].stock;
        // 商品介紹
        let newTd_description = document.createElement("td");
        if (products[i].description == null) {
          // 若介紹為空
          newTd_description.innerHTML = "無。";
        } else {
          newTd_description.innerHTML = products[i].description;
        }
        // 創建日期
        let newTd_createdDate = document.createElement("td");
        newTd_createdDate.innerHTML = products[i].createdDate;
        // 圖片連結
        let newAnchor = document.createElement("a");
        newAnchor.href = products[i].imageUrl;
        newAnchor.innerHTML = products[i].productName;
        newAnchor.target = "_blank";
        newTd_productName.appendChild(newAnchor);
        newTr.appendChild(newTd_productId);
        newTr.appendChild(newTd_productName);
        newTr.appendChild(newTd_category);
        newTr.appendChild(newTd_price);
        newTr.appendChild(newTd_stock);
        newTr.appendChild(newTd_description);
        newTr.appendChild(newTd_createdDate);
        tbody.appendChild(newTr);
      }
      // 計算分頁
      countPages(limit, products, URL);
    })
    .fail((errorThrown) => {
      console.log(errorThrown);
    });
}

// 計算分頁
function countPages(limit, products, URL) {
  if (limit.value == "") {
    limit.value = 5; // 沒有輸入值default = 5
  }
  let NumberOfPages = Math.floor(products.length / limit.value);
  let pageLink = document.getElementsByClassName("page-link");
  console.log(Number(pageLink[1].innerHTML));
  // 防呆連按查詢
  if (pageLink.length - 2 <= NumberOfPages) {
    let pagination = document.getElementsByClassName("pagination");
    //   let pageItem = document.getElementsByClassName("page-item");
    let pageItemNext = document.getElementById("a_next");
    pageItemNext.remove(); // 先將next remove，最後計算完再加回去
    for (let i = 0; i < NumberOfPages; i++) {
      let newPage = document.createElement("li");
      let newA = document.createElement("a");
      newPage.classList.add("page-item");
      newA.classList.add("page-link");
      newA.innerHTML = Number(pageLink[i + 1].innerHTML) + 1;
      newPage.appendChild(newA);
      pagination[0].append(newPage);
    }
    // 加回next;
    let newPage = document.createElement("li");
    let newA = document.createElement("a");
    newPage.classList.add("page-item");
    newA.classList.add("page-link");
    newA.setAttribute("id", "a_next");
    newA.innerHTML = "Next";
    newPage.appendChild(newA);
    pagination[0].append(newPage);

    // 創建map保存yellow的頁數，表示當下頁數
    let pageMap = new Map();
    let pages = document.getElementsByClassName("page-link");
    // 預設第一頁為當下頁數
    pageMap.set("yellow", pages[1]);
    pageMap.get("yellow").style.backgroundColor = "yellow";
    // 點擊分頁
    $("a.page-link").click((e) => {
      //   let pages = document.getElementsByClassName("page-link");
      // 如果已有yellow的頁數，先將其背景變為白色
      if (pageMap.get("yellow") !== undefined) {
        // pageMap return e.target
        pageMap.get("yellow").style.backgroundColor = "white";
      }
      //   e.target.style.backgroundColor = "yellow";
      // 若點擊的分頁不是Previous和Next才更新pageMap
      if (e.target.innerHTML != "Previous" && e.target.innerHTML != "Next") {
        console.log("111");
        // 更新設置pageMap儲存當下為yellow的頁數
        pageMap.set("yellow", e.target);
        // 變更backgroundColor為yellow表示當下頁數
        pageMap.get("yellow").style.backgroundColor = "yellow";
      }
      if (e.target.innerHTML == "Previous") {
        // 避免點擊Previous時當下分頁數是1導致被扣至0
        if (Number(pageMap.get("yellow").innerHTML) > 1) {
          // 將當下page color變為白色
          pageMap.get("yellow").style.backgroundColor = "white";
          // 更新設置pageMap儲存當下為yellow的 - 1頁數
          pageMap.set(
            "yellow",
            pages[Number(pageMap.get("yellow").innerHTML) - 1]
          );
          // 變更backgroundColor為yellow表示當下頁數
          pageMap.get("yellow").style.backgroundColor = "yellow";
        }
      } else if (e.target.innerHTML == "Next") {
        // 避免點擊Next時當下分頁數是最後一頁導致加總超過總頁數
        if (Number(pageMap.get("yellow").innerHTML) < pages.length - 1) {
          // 將當下page color變為白色
          pageMap.get("yellow").style.backgroundColor = "white";
          // 更新設置pageMap儲存當下為yellow的 + 1頁數
          pageMap.set(
            "yellow",
            pages[Number(pageMap.get("yellow").innerHTML) + 1]
          );
          // 變更backgroundColor為yellow表示當下頁數
          pageMap.get("yellow").style.backgroundColor = "yellow";
        }
      }
      //   if (Number(e.target.innerHTML) - 1 >= 0) {
      //     let offset = (Number(e.target.innerHTML) - 1) * 5;
      //     if (URL.search("offset") < 0) {
      //       if (URL != "http://localhost:8080/products" && offset > 0) {
      //         // 表示不是第一個被選擇的表單
      //         URL += "&offset=" + offset;
      //       } else {
      //         URL += "?offset=" + offset;
      //       }
      //     } else {
      //       URL = URL.substring(0, URL.length - 1) + offset;
      //     }
      //     console.log(URL);
      //     ajaxCreateTable(URL);
      //   }
      if (Number(pageMap.get("yellow").innerHTML) - 1 >= 0) {
        let offset = (Number(pageMap.get("yellow").innerHTML) - 1) * 5;
        if (URL.search("offset") < 0) {
          if (URL != "http://localhost:8080/products" && offset > 0) {
            // 表示不是第一個被選擇的表單
            URL += "&offset=" + offset;
          } else {
            URL += "?offset=" + offset;
          }
        } else {
          URL = URL.substring(0, URL.length - 1) + offset;
        }
        console.log(URL);
        ajaxCreateTable(URL);
      }
    });
  }
}

// 新增商品功能頁籤
$("#nav-createProduct").click(() => {
  // 隱藏商品查詢功能container
  $("div.productsSelect").css("display", "none");
  // 隱藏修改商品功能container
  $("div.updateProduct").css("display", "none");
  // 顯示創建商品功能container
  $("div.createProduct").css("display", "");
});

// 點擊reset button
$("#reset").click(() => {
  // 將所有選單的value變空值
  document.getElementById("productName").value = "";
  document.getElementsByClassName("form-check-input")[0].checked = true;
  document.getElementById("productImageUrl").value = "";
  document.getElementById("productPrice").value = "";
  document.getElementById("productStock").value = "";
  document.getElementById("productDescription").value = "";
  $("div.create-success").css("display", "none");
  $("div.create-failed").css("display", "none");
});

// 點擊submit button
$("#createProductSubmit").click(() => {
  $("div.create-success").css("display", "none");
  $("div.create-failed").css("display", "none");
  // 建立productObject物件
  let productData = {};
  // 商品名稱
  productData["productName"] = document.getElementById("productName").value;
  // 商品類別
  let categoryCheck = document.getElementsByClassName("form-check-input");
  for (let i = 0; i < categoryCheck.length; i++) {
    // 判斷哪個類別為checked狀態
    if (categoryCheck[i].checked) {
      if (categoryCheck[i].id == "car-check") {
        productData["category"] = "CAR";
      } else if (categoryCheck[i].id == "food-check") {
        productData["category"] = "FOOD";
      } else if (categoryCheck[i].id == "book-check") {
        productData["category"] = "E_BOOK";
      }
    }
  }
  // 商品圖片連結
  productData["imageUrl"] = document.getElementById("productImageUrl").value;
  // 商品價格
  productData["price"] = document.getElementById("productPrice").value;
  // 商品庫存
  productData["stock"] = document.getElementById("productStock").value;
  // 商品描述
  productData["description"] =
    document.getElementById("productDescription").value;
  console.log(productData);

  // postMapping連接api
  let URL = "http://localhost:8080/products";
  $.ajax({
    url: URL,
    data: JSON.stringify(productData),
    type: "POST",
    dataType: "json",
    contentType: "application/json",
    success: function (returnData) {
      console.log(returnData);
      // 顯示成功
      $("div.create-success").css("display", "");
    },
    error: function (xhr, ajaxOptions, thrownError) {
      console.log(xhr.status);
      console.log(thrownError);
      // 顯示失敗
      $("div.create-failed").css("display", "");
    },
  });
});

// 修改商品功能頁籤

// 點擊reset button
$("#nav-updateProduct").click(() => {
  // 隱藏商品查詢功能container
  $("div.productsSelect").css("display", "none");
  // 隱藏新增商品功能container
  $("div.createProduct").css("display", "none");
  // 顯示創建商品功能container
  $("div.updateProduct").css("display", "");
});

// 點擊重置選項
$("#reset-update").click(() => {
  console.log("click!!");
  // 將所有選單的value變空值
  document.getElementById("productId").value = "";
  document.getElementById("productName-update").value = "";
  document.getElementsByClassName("form-check-input")[0].checked = true;
  document.getElementById("productImageUrl-update").value = "";
  document.getElementById("productPrice-update").value = "";
  document.getElementById("productStock-update").value = "";
  document.getElementById("productDescription-update").value = "";
  $("div.update-success").css("display", "none");
  $("div.update-failed").css("display", "none");
});

// 點擊Submit
$("#updateProductSubmit").click(() => {
  $("div.update-success").css("display", "none");
  $("div.update-failed").css("display", "none");
  $("div.delete-success").css("display", "none");
  // 商品類別
  let productData = {};
  // 商品編號
  productData["productId"] = document.getElementById("productId").value;
  // 商品名稱
  productData["productName"] =
    document.getElementById("productName-update").value;
  // 商品類別
  let categoryCheck = document.getElementsByClassName("form-check-input");
  for (let i = 0; i < categoryCheck.length; i++) {
    // 判斷哪個類別為checked狀態
    if (categoryCheck[i].checked) {
      if (categoryCheck[i].id == "car-check") {
        productData["category"] = "CAR";
      } else if (categoryCheck[i].id == "food-check") {
        productData["category"] = "FOOD";
      } else if (categoryCheck[i].id == "book-check") {
        productData["category"] = "E_BOOK";
      }
    }
  }
  // 商品圖片連結
  productData["imageUrl"] = document.getElementById(
    "productImageUrl-update"
  ).value;
  // 商品價格
  productData["price"] = document.getElementById("productPrice-update").value;
  // 商品庫存
  productData["stock"] = document.getElementById("productStock-update").value;
  // 商品描述
  productData["description"] = document.getElementById(
    "productDescription-update"
  ).value;
  console.log(productData);

  // PutMapping連接api
  let URL = "http://localhost:8080/products";
  URL += "/" + productData["productId"];
  $.ajax({
    url: URL,
    data: JSON.stringify(productData),
    type: "PUT",
    dataType: "json",
    contentType: "application/json",
    success: function (returnData) {
      console.log(returnData);
      // 顯示成功
      $("div.update-success").css("display", "");
    },
    error: function (msg) {
      console.log(msg);
      // 顯示失敗
      $("div.update-failed").css("display", "");
    },
  });
});

// 點擊Delete Button
$("#updateProductDelete").click(() => {
  $("div.update-success").css("display", "none");
  $("div.update-failed").css("display", "none");
  $("div.delete-success").css("display", "none");
  let productData = {};
  productData["productId"] = document.getElementById("productId").value;
  // 先將不可空白欄位的require屬性拿掉
  document.getElementById("productName-update").required = "";
  document.getElementById("productPrice-update").required = "";
  document.getElementById("productStock-update").required = "";

  // DeleteMapping連接api
  let URL = "http://localhost:8080/products";
  URL += "/" + productData["productId"];
  $.ajax({
    url: URL,
    data: JSON.stringify(productData),
    type: "DELETE",
    dataType: "json",
    contentType: "application/json",
    success: function () {
      // 顯示成功
      $("div.delete-success").css("display", "");
    },
  });

  // 先將不可空白欄位的require屬性拿掉
  document.getElementById("productName-update").required = "required";
  document.getElementById("productPrice-update").required = "required";
  document.getElementById("productStock-update").required = "required";
});
